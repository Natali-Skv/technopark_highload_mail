# Проектирование веб-сервиса

## [Методические указания](https://github.com/init/highload/blob/main/homework_architecture.md)
---

## Содержание

* ### [Тема и целевая аудитория](#тема_и_ца)
* ### [Расчет нагрузки](#рассчет_нагрузки)
* ### [Логическая схема](#логическая_схема)
* ### [Физическая схема](#физическая_схема)
* ### [Технологии](#технологии)
* ### [Схема проекта](#схема_проекта)
* ### [Список серверов](#список_серверов)
* ### [Источники](#источники)

---

## 1. <a name="тема_и_ца">Тема и целевая аудитория</a>

#### :white_medium_small_square: тип сервиса: почта

#### :white_medium_small_square: о сервисе: сервис по пересылке и получению электронных сообщений между пользователями интернета

#### :white_medium_small_square: mvp:

* регистрация
* авторизация
* просмотр списка входящих писем (со статусами прочитанно/не прочитанно)
* просмотр списка исходящих писем
* просмотр спама
* чтение письма
* отправка письма
* скачивание вложения из письма
* возможность прикрепить вложение
* удаление письма
* отметка письма как спам, внесение отправителя в спам-список
* удаление спам-писем по истечении 30 дней
* редактирование личного профиля
* удаление почтового ящика

#### :white_medium_small_square: Целевая аудитория

* Сервис ориентирован на жителей РФ.
* Размер целевой аудитории [[1]](#источник_1)

| метрика                             | значение   |
|-------------------------------------|------------|
| месячная аудитория (кроссдевайс)    | 16 млн     |
| дневная аудитория (кроссдевайс)     | 6 млн      |
| среднее время (кроссдевайс) в месяц | 5 ч 46 мин |

---

## 2. <a name="рассчет_нагрузки">Расчет нагрузки</a>

### 2.1 <ins>Продуктовые метрики</ins>

#### :white_medium_small_square: Размер целевой аудитории [[1]](#источник_1)

  | метрика                             | значение   |
  |-------------------------------------|------------|
  | месячная аудитория (кроссдевайс)    | 16 млн     |
  | дневная аудитория (кроссдевайс)     | 6 млн      |
  | среднее время (кроссдевайс) в месяц | 5 ч 46 мин |

#### :white_medium_small_square: Предположение о среднем размере хранилища пользователя

* **профиль пользователя**    
  | поле                                     | ~объём
  |------------------------------------------|  ---------
  | id                                       | **4 байт**
  | почтовый адрес                           | 20 сиволов (UTF-8) = **20 байт**
  | почтовый адрес для восстановления пароля | 20 сиволов (UTF-8) = **20 байт**
  | номер телефона для восстановления пароля | 11 символов = **11 байт**
  | хеш-пароля                               | **32 байт**
  | соль                                     | **8 байт**
  | имя                                      | 7 символов (UTF-8) = **14 байт**
  | фамилия                                  | 10 символов (UTF-8) = **20 байт**
  | фото профиля                             | 180 * 180, jpeg = **10 Кбайт**
  | пол                                      | **1 байт**
  | часовой пояс                             | **16 байт**
  | список отправителей спама                | 50 * 4 байт = **200 байт**
  | **ИТОГО**                                | **~10,4 Кб**

* **хранилище писем пользователя**  
  Предоставим для каждого пользователя **10 Гб**, для хранения своих входящих и исходящих писем (анологичные ограничения
  присутствуют в Почта@mail.ru [[3]](#источник_3) = 8 Гб, gmail [[4]](#источник_4) = 15 Гб).
     
  - Средний объем письма без учета вложения — **0,1 Мб**.    
  - **10%** входящих писем содержат вложения, а **90%** не содержат.
  - **40%** исходящих писем содержат вложения, а **60%** не содержат. 
  - Средний размер вложения — **10 Мб**  
  - Средний объем почтового ящика **5 Гб**.
  - Вложения письма будем хранить в хранилище отправляющего.
  - Исходящих писем в 5 раз меньше входящих.
  Таким образом средний пользователь сможет хранить `5 Гб / (40% * 20 Мб / 5) ~= 6 250 писем`.  
    
#### :white_medium_small_square: Предположение о среднем количестве действий пользователя по типам в день

| действие                                      | количество в день |
|-----------------------------------------------|-------------------|
| загрузка главной страницы (входящие)          | 5                 |
| чтение письма                                 | 20                |
| отправка письма                               | 2                 |
| просмотр входящих писем (не первая страница)  | 1                 |
| скачивание вложения                           | 3                 |
| удаление письма                               | 3                 |
| просмотр исходящих писем                      | 1                 |
| просмотр спама                                | 0,5               |
| авторизация                                   | 0,05              |
| добавление отправителя в спам                 | 0,05              |
| редактирование личного профиля                | 0,005             |
| регистрация                                   | 0                 |

### 2.2 <ins>Технические метрики</ins>

#### :white_medium_small_square: Размер хранилища в разбивке по типам данных (в Тб) - для существенных блоков данных

* Размер хранилища для информации о профилях пользователей
  При наличии 16 млн. месячной аудитории, будем считать, что всего зарегистрированных аккаунтов 20 млн.
  Аккаунты, которые не проявляли активность 2 года автоматически удаляются (аналогично яндекс почте [[5]](#источник_5)).
  Таким образом, на хранение информации профиля пользователей:  
  `20 млн * 10,4 Кб = 0,19 Тб`
* Размер хранилища для писем пользователей  
  `20 млн * 5 Гб =  10^5 Тб`

#### :white_medium_small_square: Основной сетевой трафик

* **RPS в разбивке по типам запросов (запросов в секунду) - для основных запросов**  
  Будем считать, что в пик нагрузки в 2 раза больше запросов, чем в среднем  
  Пусть в день у нас регистрируется 1000 аккаунтов  
  `rps_avg = (кол-во действий на одного пользователя/сутки * 6 млн )/(24 * 60 * 60)`
  
  | действие                                     |кол-во на одного пользователя/сутки| rps (пик) | rps (avg) |
  |----------------------------------------------|-----------------------------------|-----------|-----------|
  | загрузка главной страницы (входящие)         | 5                                 | 694       | 347       |
  | чтение письма                                | 20                                | 2778      | 1389      |
  | отправка письма                              | 2                                 | 278       | 139       |
  | просмотр входящих писем (не первая страница) | 1                                 | 140       | 70        |
  | скачивание вложения                          | 3                                 | 417       | 208       |
  | удаление письма                              | 3                                 | 417       | 208       |
  | просмотр исходящих писем                     | 1                                 | 140       | 70        |
  | просмотр спама                               | 0,5                               | 70        | 35        |
  | авторизация                                  | 0,05                              | 7         | 3,5       |
  | добавление отправителя в спам                | 0,05                              | 7         | 3,5       |
  | редактирование личного профиля               | 0,005                             | 0,7       | 0,4       |
  | регистрация                                  | 0                                 | 0,02      | 0,01      |

* **Рассчет сетевого потребления на статику.**  
  Для рассчета трафика преходящегося на статику (JS,CSS,imgs) проведем небольшой эксперимент: определим объем такого трафика на *yandex почте* и *почте     mail.ru*.  
  Отразим в таблице трафик, переданный по сети (transferred over network), то есть не будем учитывать статику, взятую из кеша браузера.  
  Будем следовать более или менее классическому сценарию использования почтового сервиса:  
    
        1. перейти на страницу входящих
        2. перейти на страницу одного письма
        3. вернуться на страницу входящих
        4. повторим пункты 2-3 10 раз для разных писем
        5. перейти на страницу исходящих
        6. перейти на страницу одного исходящего письма
  
  Так как страница входящих писем -- главная, то при открытии ее единственный раз загружается общая для всего web-приложения статика      (JS,CSS,логотипы,иконки итд).  
  Отобразим результаты в таблице. Трафик от рекламных банеров не учитывался.  
                                            
  | страница                                                   |yandex почта  | почта mail.ru |avg     |
  |------------------------------------------------------------|--------------|---------------|--------|
  | главная страница (входящие письма)                         | 3,4 Мб       | 3,4 Мб        | 3,4 Мб |
  | входящие письма, просмотр не первой страницы (по 30 писем) | 50 Кб        | 327 Кб        | 188 Мб |
  | одного письма(средний объем трафика среди 10 писем)        | 110 Кб       | 100 Кб        | 105 Кб |

* **Пиковое потребление в теченнии суток (в Гбит/с). Разбивка по существенным типам трафика (для выбора сетевых
  интерфейсов)**  
  Список входящих, исходящих и спама будем выдавать постанично, по 30 писем на странице.   
  Так как страницы списка входящих, исходящих и спама очень похожи по своей структуре, будем считать сетевое потребление на их загрузку одинаковым и равным значению колонки **avg** в таблице, приведенной в прошлом пункте.  

  | действие                                    | rps (пик) |потребление на одну страницу (вложение)|пиковое потребление Гбит/с|
  |---------------------------------------------|-----------|---------------------------------------|--------------------------|
  | загрузка главной страницы (входящие)        | 694       | 3,4 Мб                                | 18,9 |
  | чтение письма                               | 2778      | 105 Кб                                | 2,3  |
  | отправка письма                             | 278       | 0,1 Мб + (40% * 10 Мб)                | 1,13 |
  | просмотр входящих писем (не первая страница)| 140       | 188 Кб                                | 0,2  |
  | скачивание вложения                         | 417       | 10 Мб                                 | 33,4 |
  | просмотр исходящих писем                    | 140       | 188 Кб                                | 0,2  |


* **Суммарный суточный (Гбайт/сутки) - разбивка по существенным типам трафика (опционально, для подсчета стоимости
  хостинга)**  

  | действие                                    |суточное потребление, Гбайт/сутки|
  |---------------------------------------------|--------------------------------|
  | загрузка главной страницы (входящие)        | 102 060                        |
  | чтение письма                               | 12 420                         |
  | отправка письма                             | 12 310                         |
  | просмотр входящих писем (не первая страница)| 1 080                          |
  | скачивание вложения                         | 180 090                        |
  | просмотр исходящих писем                    | 1 080                          |
  | **ИТОГО**                                   | **574 020 Гбайт/сутки**        |
  
----

## 3. <a name="логическая_схема">Логическая схема</a>
Кратное описание таблиц:  
- **ATTACHMENTS** 
  - user_references []INT -- список айдишников, пользователей, имеющих соответствующее письмо(имеющих доступ к этому вложению). Добавлено для того, чтобы когда пользователь нажимал "скачать вложение" по ID пользователя мы проверяли, есть ли текущий пользователь в user_references, то есть может ли этот пользователь скачать это вложение 
- **WIDE_MAILS** таблица создана, чтобы не дублировать текст письма для каждого из получателей (их может быть несколько) и отправителя. В эту таблицу мы должны ходить только для получения 1 конкретного письма пользователя. С этой целью в таблицы USER_X_DIRECTORY_X_MAILS были добавлены поля Preview, date, theme_preview, has_attaches. 
- **USER_X_MAILS** -- таблица всех писем, которые отображаются у пользователя. Эта таблица создана, чтобы в USER_X_DIRECTORY_X_MAILS можно было обозначать answer_to.
- **USER_X_DIRECTORIES** -- таблица директорий конкретного пользователя.  
  - name -- имя директории, например: "входящие", "корзина", "спам", "исходящие".  
  - new_mail_count -- количество писем, которые пользователь еще не видел. Для отображения значка с количеством новых писем около соответствующей директории.
- **USER_X_DIRECTORY_X_MAILS** -- семейство таблиц писем по пользователям, по папкам. То есть на каждого пользователя, по количеству папок. Данная таблица предназначена для страниц со списком писем.  
- **USER_X_ATTACHES** -- таблица вложений, конкретного пользователя Х. Вложение считается принадлежащим пользователю, если он его прикрепил в исходящем письме. Такое вложение увеличивает storage_size данного пользователя. 
Данная таблица создана для того, чтобы по запросу пользователь мог получить список своих вложений, а также удалить. При удалении каскадно удаляется и запись в ATTACHMENTS, также в соответствующем WIDE_MAIL соответствующий элемент attachment_sizes := -1. Далее, при отображении письма получателю, удаленное отправителем вложение, будет отмечено как "удалено отправителем"  

[открыть в новой вкладке](https://raw.githubusercontent.com/Natali-Skv/technopark_highload_mail/master/imgs/logic_db.png) 
![](https://github.com/Natali-Skv/technopark_highload_mail/blob/master/imgs/logic_db_100.png) 

## 4.<a name="физическая_схема">Физическая схема</a>

  | Данные   |Технология| Мотивация | Решающие свойства |
  |----------|--------------|--------|----------|
  | SESSIONS |**Tarantool**| Очень нагруженная таблица, в нее мы будем ходить почти на каждый запрос пользователя, чтобы проверить ключ сессии. Необходим быстрый доступ без возможности потери данных |хранение данных в RAM, cогласованность и сохранность данных в случае сбоя [[6]](#источник_6);|
  | USERS, ATTACHES, WIDE_MAILS | **PostgreSQL** |Данные хорошо ложатся на реляционную модель; нет full-scan запросов, только по id | реляционная модель; популярная технология; высокая поддержка; cогласованность и сохранность данных в случае сбоя;|   
  | USER_X_MAILS, USER_X_DIRECTORIES, USER_X_DIRECTORY_X_MAILS, USER_X_ATTACHES | отдельная **SQLite** для каждого набора таблиц конкретного пользователя | Данные хорошо ложатся на реляционную модель; нужна возможность хранить отдельную БД для каждого пользователя, чтобы избежать крайне тяжелые full-scan запросы|реляционная модель; встраиваемая БД; популярная технология; высокая поддержка; cогласованность и сохранность данных в случае сбоя;|  
  | Вложения | **S3** |очень большой объем данных; возможность сэкономить на покупке собственных серверов; возможность сэкономить засчет гибкой тарификации(cold data); |популярная технология; высокая поддержка; надежность, доступность;|
  | Аватарки пользователей | **FS** |небольшой объем данных, очень большое количество запросов на получение, крайне редкие запросы на обновление |популярная технология; высокая поддержка; надежность, доступность;|

  ### Индексы
  |ТАБЛИЦА: поле | Мотивация  |
  |----------------|------------|
  |SESSION:session_key|необходимо для всех запросов пользователя (кроме запросов на логин)|
  |USERS:email|необходимо для запросов на логин, отправку письма(поиск получателей)|
  |WIDE_MAILS:id|необходимо для быстрого поиска письма по id (запрос на чтение конкретного письма)|
  |ATTACHMENTS:id|необходимо для быстрого поиска вложения по id (запрос на скачивание вложения, удаление вложения отправителем соответствующего письма)|
  |USER_X_MAILS:id|необходимо для быстрого поиска папки письма (запрос на получение письма с непустым answer_to, в этом случае внизу письма отображается превью answer_to письма)|
  |USER_X_DIRECTORIIES:name|необходимо быстро по имени директории определять id (запрос на получение писем конкретной директории по ее имени)|
  |USER_X_DIRECTORY_X_MAILS:id|необходимо быстро находить письмо по id (запрос на получение новых писем, запрос на чтение конкретного письма, запрос на изменение статуса письма (прочитано/непрочитано), запрос на удаление письма)|
  |USER_X_DIRECTORY_X_MAILS:date|необходимо быстро сортировать письма по дате (запрос на получение писем определенной папки)|
  |USER_X_DIRECTORY_X_MAILS:status|необходимо быстро сортировать письма по статусу (запрос на получение писем определенной папки)|
  |USER_X_ATTACHMENTS:id|необходимо быстро получать вложение по id (запрос на удаление вложения отправителем)|
  |USER_X_ATTACHMENTS:size|необходимо быстро сортировать вложения по размеру(запрос на список вложений пользователя)|

[открыть в новой вкладке](https://raw.githubusercontent.com/Natali-Skv/technopark_highload_mail/master/imgs/store.png) 
![](https://github.com/Natali-Skv/technopark_highload_mail/blob/master/imgs/store_100.png) 

### Шардинг
**Tarantool**:   
В нашем случае на Tarantool основная нагрузка -- SELECT-запросы. Обновление данных происходит только при запросе на выход из аккауна, выход со всех устройств, вход. Максимальное RPS ~ 5 000.
> Критическое значение RPS для запросов типа SELECT/INSERT/UPDATE/DELETE – 100 000.  
> Если основная нагрузка генерируется SELECT-запросами, следует добавить slave-сервер и часть запросов обрабатывать на нем.[[8]](#источник_8)  
   
Также данные, которые мы храним в Tarantool будут помещаться в `20 000 000 * 3 * 300 Б = 18Гб`
Таким образом на Tarantool можно не реализовывать шардинг.  

**SQLite**:  
Данные, расположенные в одном файле SQLite принадлежат одному конкретному пользователю. То есть мы можем сделать шарды по диапозонам id пользователей.    
Если конкретный шард становится перегруженным, можно просто перенести файлы SQLite части диапозона пользователей на другой шард.  

**PostgreSQL**:  
В таблицы, расположенные в PostgreSQL, не будет full-scan запросов, что упрощает шардинг. 
В выбранной схеме данных, все данные можно разделить на шарды по диапозонам user_id.   
Записи в WIDE_MAILS будут принадлежать конкретному шарду, если id отправителя этого письма принадлежит диапозону user_id данного шарда.  
Записи в ATTACHMENTS будут принадлежать конкретному шарду, если id отправителя соответствующего письма принадлежит диапозону user_id данного шарда.  
При шардинге следует учесть вероятные проблемы с балансировкой нагрузки между шардами. Для этого на одном сервере создается сразу несколько шардов (например 100). Тогда если сервер начинает переполняться, половину шардов можно перенести на другой сервер.

## 5. <a name="технологии">Технологии</a>

Сводная таблица: технология, область примерения, мотивационная часть

## 6. <a name="схема_проекта">Схема проекта</a>

Сущности:
- пользователь
- письмо
- вложение

Схема взаимодействия сервисов внутри проекта (картинка). Должно быть описано как ходят потоки данных, как устроена
балансировка (внутренняя и внешняя).

## 7. <a name="список_серверов">Список серверов</a>

Таблица с конфигурациями, количеством серверов и сервисами расположенными на них. В случае использования kubernetes или
иной виртуализации, список контейнеров с аллокацией ресурсов.

----

## 8. <a name="источники">Источники</a>

<a name="источник_1"> 1. https://radar.yandex.ru/yandex?month=2022-07 </a>  
<a name="источник_2"> 2. https://www.lifewire.com/what-is-the-average-size-of-an-email-message-1171208#:~:text=The%20average%20size%20of%20an,text%20or%20about%2037.5%20pages.</a>  
<a name="источник_3"> 3. https://help.mail.ru/cloud_web/faq/free </a>  
<a name="источник_4"> 4. https://support.google.com/googleone/answer/9004014?hl=en </a>  
<a name="источник_5"> 5. https://yandex.ru/support/mail/freezing.html </a>  
<a name="источник_6"> 6. https://www.bigdataschool.ru/wiki/tarantool </a>  
<a name="источник_7"> 7. https://www.tarantool.io/ru/doc/latest/concepts/sharding/ </a>  
<a name="источник_8"> 7. https://dist.tarantool.io/pdf/Tarantool.2.1.1.ru.pdf </a>  
