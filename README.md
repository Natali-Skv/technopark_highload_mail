# Проектирование веб-сервиса
## [Методические указания](https://github.com/init/highload/blob/main/homework_architecture.md) 
---
## Содержание
* ### [Тема и целевая аудитория](#тема_и_ца) 
* ### [Расчет нагрузки](#рассчет_нагрузки) 
* ### [Логическая схема](#логическая_схема) 
* ### [Физическая схема](#физическая_схема) 
* ### [Технологии](#технологии) 
* ### [Схема проекта](#схема_проекта) 
* ### [Список серверов](#список_серверов) 
* ### [Источники](#источники) 
---
## 1. <a name="тема_и_ца">Тема и целевая аудитория</a> 
#### :white_medium_small_square: тип сервиса: почта  

#### :white_medium_small_square: о сервисе: сервис по пересылке и получению электронных сообщений между пользователями интернета  

#### :white_medium_small_square: mvp:
  * регистрация
  * авторизация
  * просмотр списка входящих писем (со статусами прочитанно/не прочитанно)
  * просмотр списка исходящих писем
  * чтение письма
  * отправка письма
  * скачивание вложения из письма
  * возможность прикрепить вложение
  * удаление письма
  * отметка письма как спам, внесение отправителя в спам-список
  * удаление спам-писем по истечении 30 дней
  * редактирование личного профиля
  * удаление почтового ящика


#### :white_medium_small_square: Целевая аудитория
* Сервис ориентирован на жителей РФ.  
* Размер целевой аудитории [[1]](#источник_1)  
    метрика  | значение
    ---------| --------------------------------
    месячная аудитория (кроссдевайс) | 90 млн
    дневная аудитория (кроссдевайс) | 50 млн
    среднее время (кроссдевайс) в месяц | 800 мин = 48 000 с

---
## 2. <a name="рассчет_нагрузки">Расчет нагрузки</a> 
### 2.1 <ins>Продуктовые метрики</ins>
#### :white_medium_small_square: Размер целевой аудитории [[1]](#источник_1) 
метрика  | значение
---------| --------------------------------
месячная аудитория (кроссдевайс) | 90 млн
дневная аудитория (кроссдевайс) | 50 млн
среднее время (кроссдевайс) в месяц | 800 мин = 48 000 с

#### :white_medium_small_square: Предположение о среднем размере хранилища пользователя
* **профиль пользователя**  
    поле | ~объём
    ---------| --------------------------------
    id | **4 байт**
    почтовый адрес | 20 сиволов (UTF-8) = **20 байт**
    почтовый адрес для восстановления пароля| 20 сиволов (UTF-8) = **20 байт** 
    номер телефона для восстановления пароля | 11 символов = **11 байт**
    хеш-пароля | **32 байт**
    соль | **8 байт**
    имя | 7 символов (UTF-8) = **14 байт**
    фамилия | 10 символов (UTF-8) = **20 байт**
    фото профиля | 180 * 180, jpeg = **10 Кбайт**
    пол | **1 байт**
    часовой пояс | **16 байт**
    список отправителей спама | 50 * 4 байт = **200 байт**
    **ИТОГО** | **~10,4 Кб**

* **хранилище писем пользователя**  
    Предоставим для каждого пользователя **10 Гб**, для хранения своих входящих и исходящих писем (анологичные ограничения присутствуют в Почта@mail.ru [[3]](#источник_3) = 8 Гб, gmail [[4]](#источник_4) = 15 Гб).  
    Средний объем письма -- **75 Кб** [[2]](#источник_2). Пусть **40%** писем содержат вложения, а **60%** не содержат.  
    Пусть также средний размер письма без вложения **6Кб**. Тогда средний размер письма с вложением **178,5 Кб**, где **175 Кб** занимает вложение, а **3,5 Кб** -- текст письма.
    Пусть средний объем почтового ящика **5 Гб**, то есть ~ 5 Гб / 75 Кб = 70 000 писем

#### :white_medium_small_square: Предположение о среднем количестве действий пользователя по типам в день
действие | количество в день
---------| --------------------------------
чтение письма | 20
отправка письма | 20
просмотр входящих писем | 10
скачивание вложение | 6
удаление письма | 3
просмотр исходящих писем | 2
авторизация | 0,05
добавление отправителя в спам | 0,05
редактирование личного профиля |  0,005
регистрация | 0

### 2.2 <ins>Технические метрики</ins>
#### :white_medium_small_square: Размер хранилища в разбивке по типам данных (в Тб) - для существенных блоков данных
* Размер хранилища для информации о профилях пользователей 
    При наличии 90 млн. месячной аудитории, будем считать, что всего зарегистрированных аккаунтов 120 млн. 
    Аккаунты, которые не проявляли активность 2 года автоматически удаляются (аналогично яндекс почте [[5]](#источник_5)).
    Таким образом, на хранение информации профиля пользователей:  
120 млн * 10,4 Кб = **1,14 Тб**
* Размер хранилища для писем пользователей  
5 Гб * 120 млн = **5,5 * 10^5 Тб**

#### :white_medium_small_square: Основной сетевой трафик
* **RPS в разбивке по типам запросов (запросов в секунду) - для основных запросов**  
    Будем считать, что в пик нагрузки в 2 раза больше запросов, чем в среднем  
    Пусть в день у нас регистрируется 1000 аккаунтов
    rps_avg = (кол-во действий на одного пользователя/сутки * 90 млн )/ (24 * 60 * 60)
    действие | rps (пик) | rps (avg)
    ---------| ----------|----------
    чтение письма | 41 666,6  | 20 833,3
    отправка письма | 41 666,6 | 20 833,3
    просмотр входящих писем | 20 833,3 | 10 416,6 
    скачивание вложения | 12 500 | 6 250 
    удаление письма | 6 250 | 3 125 
    просмотр исходящих писем | 4 166,6 | 2 083,3 
    авторизация | 104 | 52 
    добавление отправителя в спам | 104 | 52 
    редактирование личного профиля | 10,4 | 5,2 
    регистрация | 0,023 | 0,011 


* **Пиковое потребление в теченнии суток (в Гбит/с) - разбивка по существенным типам трафика (для выбора сетевых интерфейсов)**  
    Входящие и исходящие письма будем выдавать постанично, по 50 писем на странице
    Превью письма ~100 символов тела письма + темы (UTF-4) + дата + адрес отправителя ~= 200 + 20 + 20 = 240 байт 
    Пусть писем с вложениями 40% от общего числа.
    действие | rps (пик) | Гбит/с
    ---------| ----------|----------
    отправка письма | 41 666,6 | 41 666,6 * 75 Кб = **25 Гбит/с**
    скачивание вложения | 12 500 | 12 500 * 175 Кб = **17,5 Гбит/с** 
    просмотр входящих писем | 20 833,3 | 20 833,3 * 50 * 240 байт = **2 Гбит/с**
    чтение письма | 41 666,6 | 41 666,6 * (6 Кб * 0,6 + 3,5 Кб * 0,4) = **1,667 Гбит/с**
    просмотр исходящих писем | 4 166,6  | 4 166,6 * 50 * 240 = **0,4 Гбит/с**

* **Суммарный суточный (Гбайт/сутки) - разбивка по существенным типам трафика (опционально, для подсчета стоимости хостинга)**  
    действие | Гбайт/сутки
    ---------|----------
    просмотр входящих писем |  1 Гбит/с * 60 * 60 * 24 = **10 800 Гбайт/сутки**
    просмотр исходящих писем | 0,2 Гбит/с * 60 * 60 * 24 =  **2 160 Гбайт/сутки**
    чтение письма | 0,833 Гбит/с * 60 * 60 * 24 = **9 001,75 Гбайт/сутки**
    отправка письма | 12,5 Гбит/с * 60 * 60 * 24 = **135 000 Гбайт/сутки**
    скачивание вложений | 8,75 Гбит/с * 60 * 60 * 24 = **94 500 Гбайт/сутки**
    **ИТОГО** | **529 200 Гбайт/сутки**
----
## 3. <a name="логическая_схема">Логическая схема</a> 
### Требования
* Картинка со списком таблиц, полей и связей между ними без привязки к конкретным базам и шардингу
## 4.<a name="физическая_схема">Физическая схема</a>  
### Требования
* Картинка со списком таблиц, полей и связей между ними с привязкой к конкретным базам, с указанием индексов и схемы шардинга
## 5. <a name="технологии">Технологии</a> 
Сводная таблица: технология, область примерения, мотивационная часть
## 6. <a name="схема_проекта">Схема проекта</a> 
Схема взаимодействия сервисов внутри проекта (картинка). Должно быть описано как ходят потоки данных, как устроена балансировка (внутренняя и внешняя).
## 7. <a name="список_серверов">Список серверов</a> 
Таблица с конфигурациями, количеством серверов и сервисами расположенными на них. В случае использования kubernetes или иной виртуализации, список контейнеров с аллокацией ресурсов.

----
## 8. <a name="источники">Источники</a>  
<a name="источник_1"> 1. https://radar.yandex.ru/yandex?month=2022-07 </a>  
<a name="источник_2"> 2. https://www.lifewire.com/what-is-the-average-size-of-an-email-message-1171208#:~:text=The%20average%20size%20of%20an,text%20or%20about%2037.5%20pages.</a>  
<a name="источник_3"> 3. https://help.mail.ru/cloud_web/faq/free </a>  
<a name="источник_4"> 4. https://support.google.com/googleone/answer/9004014?hl=en </a>  
<a name="источник_5"> 5.https://yandex.ru/support/mail/freezing.html </a>  
